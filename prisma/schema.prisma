generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InternalOrderStatus {
  NOVO
  EMBALADO
  RETIRADO
}

enum SyncJobType {
  MARK_AS_SHIPPED
}

enum SyncJobStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

enum UserRole {
  ADMIN
  EXPEDICAO
}

enum ModulePermission {
  ADMIN
  SETTINGS
  EXPEDICAO
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  role         UserRole
  passwordHash String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  workspaces   Workspace[]

  @@unique([email])
}

model Workspace {
  id           String         @id @default(cuid())
  name         String
  userId       String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  user         User?           @relation(fields: [userId], references: [id])
  members      Membership[]
  tinySettings TinySettings?

  @@unique([name])
}

model Membership {
  id          String             @id @default(cuid())
  workspaceId String
  userId      String
  email       String?
  permissions ModulePermission[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  workspace   Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
}

model TinySettings {
  id                String    @id @default(cuid())
  workspaceId       String    @unique
  apiTokenEncrypted String
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Order {
  id              String              @id @default(cuid())
  tinyOrderId     String              @unique
  orderNumber     String?
  customerName    String?
  customerCpfHash String?
  statusTiny      String?
  statusInterno   InternalOrderStatus @default(NOVO)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  pickups         Pickup[]
  syncJobs        SyncJob[]

  @@index([customerCpfHash])
  @@index([statusInterno])
}

model Operator {
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  pickups   Pickup[]
}

model Pickup {
  id            String    @id @default(cuid())
  orderId       String
  cpfLast4      String?
  operatorId    String?
  retrieverName String?
  photo         String?   @db.Text
  createdAt     DateTime  @default(now())

  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  operator      Operator? @relation(fields: [operatorId], references: [id])

  @@index([orderId])
  @@index([operatorId])
}

model SyncJob {
  id            String        @id @default(cuid())
  type          SyncJobType
  status        SyncJobStatus @default(PENDING)
  attempts      Int           @default(0)
  lastError     String?

  orderId       String?
  payload       Json?

  scheduledAt   DateTime      @default(now())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  order         Order?        @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([scheduledAt])
}
