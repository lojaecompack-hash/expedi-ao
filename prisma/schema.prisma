generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InternalOrderStatus {
  NOVO
  EMBALADO
  RETIRADO
}

enum SyncJobType {
  MARK_AS_SHIPPED
}

enum SyncJobStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

enum UserRole {
  ADMIN
  EXPEDICAO
  PRODUCAO
}

enum ModulePermission {
  ADMIN
  SETTINGS
  EXPEDICAO
  PRODUCAO
}

enum ProductionOperatorType {
  CORTE_SOLDA
  EXTRUSORA
}

enum ProductionOrderStatus {
  EM_ANDAMENTO
  PAUSADA
  AGUARDANDO_CONF
  CONFERIDO
  CANCELADO
}

enum TurnoType {
  MANHA
  TARDE
  NOITE
}

enum ParadaType {
  ALMOCO
  MANUTENCAO
  BANHEIRO
  SETUP
  FALTA_BOBINA
  OUTROS
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  role         UserRole
  passwordHash String
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  workspaces          Workspace[]
  operators           Operator[] @relation("UserOperators")
  productionOperators ProductionOperator[] @relation("UserProductionOperators")
}

model Workspace {
  id           String         @id @default(cuid())
  name         String
  userId       String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  user         User?           @relation(fields: [userId], references: [id])
  members      Membership[]
  tinySettings TinySettings?

  @@unique([name])
}

model Membership {
  id          String             @id @default(cuid())
  workspaceId String
  userId      String
  email       String?
  permissions ModulePermission[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  workspace   Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
}

model TinySettings {
  id                String    @id @default(cuid())
  workspaceId       String    @unique
  apiTokenEncrypted String
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Order {
  id              String              @id @default(cuid())
  tinyOrderId     String              @unique
  orderNumber     String?
  customerName    String?
  customerCpfHash String?
  statusTiny      String?
  statusInterno   InternalOrderStatus @default(NOVO)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  pickups         Pickup[]
  syncJobs        SyncJob[]

  @@index([customerCpfHash])
  @@index([statusInterno])
}

model Operator {
  id           String   @id @default(cuid())
  name         String
  email        String?  @unique
  phone        String?
  passwordHash String   @default("")
  isActive     Boolean  @default(true)
  userId       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user      User?    @relation("UserOperators", fields: [userId], references: [id])
  pickups   Pickup[]
  
  @@index([userId])
}

model ProductionOperator {
  id           String                   @id @default(cuid())
  name         String
  type         ProductionOperatorType
  email        String?
  phone        String?
  passwordHash String
  isActive     Boolean                  @default(true)
  userId       String?
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  user         User?                    @relation("UserProductionOperators", fields: [userId], references: [id])
  
  @@index([userId])
  @@index([type])
}

model Pickup {
  id              String    @id @default(cuid())
  orderId         String
  cpfLast4        String?
  operatorId      String?
  operatorName    String?
  customerName    String?
  customerCpfCnpj String?
  retrieverName   String?
  trackingCode    String?
  photo           String?   @db.Text
  createdAt       DateTime  @default(now())

  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  operator      Operator? @relation(fields: [operatorId], references: [id])

  @@index([orderId])
  @@index([operatorId])
}

model SyncJob {
  id            String        @id @default(cuid())
  type          SyncJobType
  status        SyncJobStatus @default(PENDING)
  attempts      Int           @default(0)
  lastError     String?

  orderId       String?
  payload       Json?

  scheduledAt   DateTime      @default(now())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  order         Order?        @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([scheduledAt])
}

// ========================================
// MÓDULO DE PRODUÇÃO - CORTE E SOLDA
// ========================================

model Machine {
  id             String   @id @default(cuid())
  code           String   @unique
  name           String
  isActive       Boolean  @default(true)
  currentOrderId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sessoes ProductionSession[]
  paradas MachineParada[]
}

model ProductionOrder {
  id                  String                @id @default(cuid())
  code                String                @unique
  
  productSku          String
  productName         String
  productMeasure      String
  
  turnoInicial        TurnoType
  
  pesoTotalProduzido  Decimal?
  totalApara          Decimal               @default(0)
  totalPacotes        Int?
  totalUnidades       Int?
  
  confPesoReal        Decimal?
  confUnidadesReal    Int?
  confPacotesReal     Int?
  confDivergencia     Boolean               @default(false)
  confObservacao      String?
  confUserId          String?
  confAt              DateTime?
  
  consumoCola         Decimal?
  consumoLine         Decimal?
  
  status              ProductionOrderStatus @default(EM_ANDAMENTO)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  finishedAt          DateTime?
  
  createdByUserId     String
  
  bobinas   ProductionBobina[]
  pacotes   ProductionPackage[]
  aparas    ProductionApara[]
  sessoes   ProductionSession[]
  
  @@index([status])
  @@index([productSku])
}

model ProductionSession {
  id           String          @id @default(cuid())
  orderId      String
  order        ProductionOrder @relation(fields: [orderId], references: [id])
  
  operatorId   String
  operatorName String
  machineId    String
  machine      Machine         @relation(fields: [machineId], references: [id])
  turno        TurnoType
  
  inicioAt     DateTime        @default(now())
  fimAt        DateTime?
  
  pesoSessao   Decimal         @default(0)
  aparaSessao  Decimal         @default(0)
  
  createdAt    DateTime        @default(now())
  
  @@index([orderId])
  @@index([operatorId])
  @@index([machineId])
}

model ProductionPackage {
  id               String          @id @default(cuid())
  orderId          String
  order            ProductionOrder @relation(fields: [orderId], references: [id])
  
  sequencia        Int
  quantidade       Int
  
  sessionId        String?
  operatorName     String?
  machineName      String?
  turno            TurnoType?
  
  etiquetaCodigo   String          @unique
  etiquetaGerada   Boolean         @default(false)
  etiquetaGeradaAt DateTime?
  
  conferido        Boolean         @default(false)
  conferidoAt      DateTime?
  
  createdAt        DateTime        @default(now())
  
  @@index([orderId])
  @@index([etiquetaCodigo])
}

model ProductionApara {
  id           String          @id @default(cuid())
  orderId      String
  order        ProductionOrder @relation(fields: [orderId], references: [id])
  
  peso         Decimal
  operatorId   String
  operatorName String
  machineId    String
  turno        TurnoType
  
  createdAt    DateTime        @default(now())
  
  @@index([orderId])
}

model MachineParada {
  id           String      @id @default(cuid())
  machineId    String
  machine      Machine     @relation(fields: [machineId], references: [id])
  
  tipo         ParadaType
  motivo       String?
  
  operatorId   String?
  operatorName String?
  turno        TurnoType
  
  inicioAt     DateTime    @default(now())
  fimAt        DateTime?
  duracaoMin   Int?
  
  createdAt    DateTime    @default(now())
  
  @@index([machineId])
  @@index([tipo])
}

model ProductionDivergencia {
  id               String   @id @default(cuid())
  orderId          String
  
  qtdOperador      Int
  pesoOperador     Decimal
  pacotesOperador  Int
  
  qtdConferido     Int
  pesoConferido    Decimal
  pacotesConferido Int
  
  qtdDiferenca     Int
  pesoDiferenca    Decimal
  
  ajustadoPorId    String
  ajustadoPorName  String
  observacao       String?
  
  createdAt        DateTime @default(now())
  
  @@index([orderId])
}

model ProductionConfig {
  id              String   @id @default(cuid())
  
  colaSku         String?
  lineSku         String?
  
  colaPercent     Decimal?
  lineMetrosPorKg Decimal?
  
  aparaEstimada   Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ========================================
// BOBINAS (Múltiplas por OP)
// ========================================

model ProductionBobina {
  id              String          @id @default(cuid())
  orderId         String
  order           ProductionOrder @relation(fields: [orderId], references: [id])
  
  sequencia       Int             // 1, 2, 3...
  bobinaSku       String          // SKU da bobina
  pesoInicial     Decimal         // Peso inicial (kg)
  pesoRestante    Decimal?        // Peso que sobrou ao trocar
  bobinaOrigem    String?         // EXTRUSORA ou TERCEIRO
  
  inicioAt        DateTime        @default(now())
  fimAt           DateTime?       // Quando trocou ou finalizou
  
  createdAt       DateTime        @default(now())
  
  @@index([orderId])
}
